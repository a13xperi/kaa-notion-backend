#!/bin/bash
#
# RALPH - Multi-Agent Orchestrator for Claude Code
# Runs autonomous loops across your entire platform
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RALPH_DIR="${SCRIPT_DIR}/.ralph"
RALPH_STATE="${HOME}/.ralph/state.json"
RALPH_LOG="${HOME}/.ralph/ralph.log"
QUEUE_DIR="${RALPH_DIR}/queue"

# Colors
R='\033[0;31m' G='\033[0;32m' Y='\033[1;33m' B='\033[0;34m'
C='\033[0;36m' M='\033[0;35m' W='\033[1;37m' N='\033[0m' DIM='\033[2m'

mkdir -p "${HOME}/.ralph" "${QUEUE_DIR}"
[[ -f "${RALPH_STATE}" ]] || echo '{"agents":{},"queue":[],"status":"idle"}' > "${RALPH_STATE}"

# ══════════════════════════════════════════════════════════════
# UI Components
# ══════════════════════════════════════════════════════════════

banner() {
    echo -e "${C}"
    cat << 'EOF'
  ╦═╗╔═╗╦  ╔═╗╦ ╦
  ╠╦╝╠═╣║  ╠═╝╠═╣
  ╩╚═╩ ╩╩═╝╩  ╩ ╩
EOF
    echo -e "${N}  ${DIM}Multi-Agent Platform Orchestrator${N}"
    echo ""
}

divider() {
    echo -e "${DIM}────────────────────────────────────────${N}"
}

# ══════════════════════════════════════════════════════════════
# Platform Info
# ══════════════════════════════════════════════════════════════

show_platform() {
    echo -e "${W}PLATFORM: SAGE MVP${N}"
    divider
    echo -e "  ${C}frontend${N}    kaa-app/src     React + TypeScript"
    echo -e "  ${C}backend${N}     server/         Express + Prisma"
    echo -e "  ${C}database${N}    prisma/         PostgreSQL"
    echo -e "  ${C}tests${N}       tests/          Jest + Playwright"
    echo -e "  ${C}infra${N}       ./              Vercel + GitHub"
    echo ""
}

show_agents() {
    echo -e "${W}AGENTS${N}"
    divider
    echo -e "  ${G}claude-code${N}  Primary AI     Complex tasks, refactoring"
    echo -e "  ${B}codex${N}        Generator      Fast code generation"
    echo ""
}

# ══════════════════════════════════════════════════════════════
# Task Management
# ══════════════════════════════════════════════════════════════

create_task() {
    local zone="$1"
    local task="$2"
    local agent="${3:-claude-code}"
    local iterations="${4:-30}"
    local task_id=$(date +%s)
    local task_file="${QUEUE_DIR}/${task_id}.json"

    # Get template
    local template=""
    case "${zone}" in
        frontend) template="${RALPH_DIR}/prompts/frontend.md" ;;
        backend)  template="${RALPH_DIR}/prompts/backend.md" ;;
        database) template="${RALPH_DIR}/prompts/fullstack.md" ;;
        fullstack|full) template="${RALPH_DIR}/prompts/fullstack.md" ;;
        *) template="${RALPH_DIR}/prompts/fullstack.md" ;;
    esac

    # Create task
    cat > "${task_file}" << EOF
{
  "id": "${task_id}",
  "zone": "${zone}",
  "task": "${task}",
  "agent": "${agent}",
  "maxIterations": ${iterations},
  "status": "pending",
  "created": "$(date -Iseconds)",
  "template": "${template}"
}
EOF

    echo "${task_id}"
}

# ══════════════════════════════════════════════════════════════
# Prompt Generation
# ══════════════════════════════════════════════════════════════

generate_prompt() {
    local zone="$1"
    local task="$2"
    local requirements="${3:-}"

    local template="${RALPH_DIR}/prompts/${zone}.md"
    [[ -f "${template}" ]] || template="${RALPH_DIR}/prompts/fullstack.md"

    if [[ -f "${template}" ]]; then
        sed -e "s|{{TASK}}|${task}|g" \
            -e "s|{{REQUIREMENTS}}|${requirements}|g" \
            "${template}"
    else
        cat << EOF
# Task: ${task}

## Zone: ${zone}

## Requirements
${requirements}

## Verification
- Run tests: npm test
- Check build: npm run build

When complete, output: RALPH_COMPLETE
EOF
    fi
}

# ══════════════════════════════════════════════════════════════
# Commands
# ══════════════════════════════════════════════════════════════

cmd_new() {
    banner
    show_platform

    echo -e "${W}CREATE NEW TASK${N}"
    divider
    echo ""

    # Zone selection
    echo -e "Select zone:"
    echo -e "  ${C}1${N}) frontend   - React components, hooks, pages"
    echo -e "  ${C}2${N}) backend    - API routes, services, middleware"
    echo -e "  ${C}3${N}) database   - Prisma schema, migrations"
    echo -e "  ${C}4${N}) fullstack  - End-to-end features"
    echo -e "  ${C}5${N}) tests      - Test coverage, e2e tests"
    echo ""
    read -p "Zone [1-5]: " zone_num

    case "${zone_num}" in
        1) zone="frontend" ;;
        2) zone="backend" ;;
        3) zone="database" ;;
        4) zone="fullstack" ;;
        5) zone="tests" ;;
        *) zone="fullstack" ;;
    esac

    echo ""
    read -p "Task description: " task_desc
    echo ""
    read -p "Max iterations [30]: " max_iter
    max_iter="${max_iter:-30}"

    # Generate prompt and save to PROMPT.md
    generate_prompt "${zone}" "${task_desc}" "" > "${SCRIPT_DIR}/PROMPT.md"

    echo ""
    echo -e "${G}Task created!${N}"
    echo ""
    echo -e "  Zone:       ${C}${zone}${N}"
    echo -e "  Iterations: ${W}${max_iter}${N}"
    echo -e "  Prompt:     ${W}PROMPT.md${N}"
    echo ""
    echo -e "${Y}Next steps:${N}"
    echo "  1. Review/edit: ./ralph edit"
    echo "  2. Start loop:  ./ralph start ${max_iter}"
}

cmd_start() {
    local max="${1:-30}"

    banner

    if [[ ! -f "${SCRIPT_DIR}/PROMPT.md" ]]; then
        echo -e "${R}No PROMPT.md found${N}"
        echo ""
        echo "Create a task first:"
        echo "  ./ralph new      Interactive task creation"
        echo "  ./ralph edit     Manual prompt editing"
        exit 1
    fi

    # Update config
    cat > "${SCRIPT_DIR}/.ralph.json" << EOF
{
  "maxIterations": ${max},
  "completionPromise": "RALPH_COMPLETE",
  "started": "$(date -Iseconds)"
}
EOF

    # Reset state
    echo '{"iteration":0,"status":"running","started":"'"$(date -Iseconds)"'"}' > "${RALPH_STATE}"
    rm -f "${SCRIPT_DIR}/.ralph-stop" "${SCRIPT_DIR}/.ralph-output.log"
    touch "${SCRIPT_DIR}/.ralph-output.log"

    echo -e "${G}RALPH STARTING${N}"
    divider
    echo ""
    echo -e "  Iterations: ${W}${max}${N}"
    echo -e "  Agent:      ${C}claude-code${N}"
    echo ""

    # Show prompt preview
    echo -e "${W}TASK PREVIEW${N}"
    divider
    head -20 "${SCRIPT_DIR}/PROMPT.md" | sed 's/^/  /'
    echo -e "  ${DIM}...${N}"
    echo ""

    echo -e "${Y}Launching Claude Code...${N}"
    echo ""

    local prompt=$(cat "${SCRIPT_DIR}/PROMPT.md")

    cd "${SCRIPT_DIR}"
    exec claude --dangerously-skip-permissions "${prompt}

---
RALPH AUTONOMOUS LOOP
Work continuously. When fully complete, output: RALPH_COMPLETE"
}

cmd_parallel() {
    # Run multiple zones in parallel using tmux
    local zones=("$@")

    if [[ ${#zones[@]} -eq 0 ]]; then
        zones=("frontend" "backend")
    fi

    banner
    echo -e "${W}PARALLEL EXECUTION${N}"
    divider
    echo ""

    if ! command -v tmux &>/dev/null; then
        echo -e "${R}tmux required for parallel execution${N}"
        echo "Install with: brew install tmux"
        exit 1
    fi

    local session="ralph-parallel-$(date +%s)"
    tmux new-session -d -s "${session}"

    local first=true
    for zone in "${zones[@]}"; do
        if [[ "${first}" == "true" ]]; then
            tmux send-keys -t "${session}" "cd ${SCRIPT_DIR} && ./ralph zone ${zone} && ./ralph start" Enter
            first=false
        else
            tmux split-window -t "${session}" -h
            tmux send-keys -t "${session}" "cd ${SCRIPT_DIR} && ./ralph zone ${zone} && ./ralph start" Enter
        fi
    done

    tmux select-layout -t "${session}" tiled

    echo -e "Started parallel loops for: ${C}${zones[*]}${N}"
    echo ""
    echo -e "Attach with: ${W}tmux attach -t ${session}${N}"
    echo -e "Detach with: ${DIM}Ctrl+B then D${N}"
}

cmd_zone() {
    local zone="$1"
    local task="${2:-Implement improvements}"

    generate_prompt "${zone}" "${task}" "" > "${SCRIPT_DIR}/PROMPT.md"

    echo -e "${G}Zone prompt created: ${zone}${N}"
}

cmd_status() {
    banner

    local iter=$(jq -r '.iteration // 0' "${RALPH_STATE}" 2>/dev/null || echo 0)
    local status=$(jq -r '.status // "idle"' "${RALPH_STATE}" 2>/dev/null || echo "idle")
    local max=$(jq -r '.maxIterations // 30' "${SCRIPT_DIR}/.ralph.json" 2>/dev/null || echo 30)
    local started=$(jq -r '.started // "-"' "${RALPH_STATE}" 2>/dev/null || echo "-")

    echo -e "${W}STATUS${N}"
    divider

    case "${status}" in
        running)        echo -e "  State:      ${G}● RUNNING${N}" ;;
        complete)       echo -e "  State:      ${G}✓ COMPLETE${N}" ;;
        stopped)        echo -e "  State:      ${Y}■ STOPPED${N}" ;;
        max_iterations) echo -e "  State:      ${Y}! MAX ITERATIONS${N}" ;;
        *)              echo -e "  State:      ${DIM}○ IDLE${N}" ;;
    esac

    echo -e "  Iteration:  ${W}${iter}${N} / ${max}"
    echo -e "  Started:    ${DIM}${started}${N}"
    echo ""

    # Show recent activity
    if [[ -f "${SCRIPT_DIR}/.ralph-output.log" ]] && [[ -s "${SCRIPT_DIR}/.ralph-output.log" ]]; then
        echo -e "${W}RECENT ACTIVITY${N}"
        divider
        tail -8 "${SCRIPT_DIR}/.ralph-output.log" | sed 's/^/  /'
        echo ""
    fi

    # Show prompt status
    if [[ -f "${SCRIPT_DIR}/PROMPT.md" ]]; then
        local zone=$(grep -m1 "^## Zone" "${SCRIPT_DIR}/PROMPT.md" 2>/dev/null | cut -d: -f2 | tr -d ' ' || echo "unknown")
        echo -e "${W}CURRENT TASK${N}"
        divider
        echo -e "  Prompt:  ${G}PROMPT.md${N}"
        head -3 "${SCRIPT_DIR}/PROMPT.md" | grep -v "^#" | head -1 | sed 's/^/  /'
    else
        echo -e "  Prompt:  ${R}Missing${N} - run ./ralph new"
    fi
}

cmd_watch() {
    banner
    echo -e "${W}WATCHING RALPH${N} ${DIM}(Ctrl+C to exit)${N}"
    divider
    echo ""

    if [[ -f "${SCRIPT_DIR}/.ralph-output.log" ]]; then
        tail -f "${SCRIPT_DIR}/.ralph-output.log" 2>/dev/null
    else
        echo "Waiting for activity..."
        while true; do
            if [[ -f "${SCRIPT_DIR}/.ralph-output.log" ]]; then
                tail -f "${SCRIPT_DIR}/.ralph-output.log"
                break
            fi
            sleep 1
        done
    fi
}

cmd_stop() {
    touch "${SCRIPT_DIR}/.ralph-stop"
    jq '.status = "stopped"' "${RALPH_STATE}" > "${RALPH_STATE}.tmp" 2>/dev/null && \
        mv "${RALPH_STATE}.tmp" "${RALPH_STATE}"

    echo -e "${Y}Stop signal sent${N}"
    echo "Loop will exit on next iteration."
}

cmd_reset() {
    echo '{"iteration":0,"status":"idle","started":""}' > "${RALPH_STATE}"
    rm -f "${SCRIPT_DIR}/.ralph-stop" "${SCRIPT_DIR}/.ralph-output.log"
    echo -e "${G}Ralph reset${N}"
}

cmd_edit() {
    if command -v cursor &>/dev/null; then
        cursor "${SCRIPT_DIR}/PROMPT.md"
    elif command -v code &>/dev/null; then
        code "${SCRIPT_DIR}/PROMPT.md"
    elif [[ -n "${EDITOR:-}" ]]; then
        "${EDITOR}" "${SCRIPT_DIR}/PROMPT.md"
    else
        nano "${SCRIPT_DIR}/PROMPT.md" 2>/dev/null || vi "${SCRIPT_DIR}/PROMPT.md"
    fi
}

cmd_logs() {
    local n="${1:-50}"
    if [[ -f "${RALPH_LOG}" ]]; then
        echo -e "${W}RALPH LOGS${N} ${DIM}(last ${n})${N}"
        divider
        tail -"${n}" "${RALPH_LOG}"
    else
        echo "No logs yet"
    fi
}

cmd_dashboard() {
    # Live dashboard with watch
    watch -n 2 -c "./ralph status"
}

cmd_help() {
    banner
    show_platform

    echo -e "${W}COMMANDS${N}"
    divider
    echo ""
    echo -e "  ${C}Task Creation${N}"
    echo -e "    new              Interactive task wizard"
    echo -e "    zone <zone>      Quick zone prompt (frontend|backend|database|fullstack)"
    echo -e "    edit             Edit PROMPT.md in Cursor"
    echo ""
    echo -e "  ${C}Execution${N}"
    echo -e "    start [N]        Start loop with N iterations (default: 30)"
    echo -e "    parallel <zones> Run multiple zones in parallel (requires tmux)"
    echo -e "    stop             Stop gracefully"
    echo ""
    echo -e "  ${C}Monitoring${N}"
    echo -e "    status           Current state"
    echo -e "    watch            Live activity feed"
    echo -e "    logs [N]         Last N log entries"
    echo -e "    dashboard        Auto-refreshing status"
    echo ""
    echo -e "  ${C}Utilities${N}"
    echo -e "    reset            Clear state"
    echo -e "    help             This help"
    echo ""
    echo -e "${W}QUICK START${N}"
    divider
    echo ""
    echo "  # Interactive (recommended)"
    echo -e "  ${G}./ralph new${N}"
    echo ""
    echo "  # Quick zone task"
    echo -e "  ${G}./ralph zone frontend${N}"
    echo -e "  ${G}./ralph edit${N}              # customize"
    echo -e "  ${G}./ralph start 30${N}"
    echo ""
    echo "  # Parallel (advanced)"
    echo -e "  ${G}./ralph parallel frontend backend${N}"
    echo ""
    echo -e "${W}EXAMPLES${N}"
    divider
    echo ""
    echo "  # Frontend feature"
    echo "  ./ralph zone frontend"
    echo "  # Edit PROMPT.md: \"Add dark mode toggle\""
    echo "  ./ralph start 20"
    echo ""
    echo "  # Full-stack feature"
    echo "  ./ralph new"
    echo "  # Follow prompts..."
    echo "  ./ralph start 50"
    echo ""
}

# ══════════════════════════════════════════════════════════════
# Main
# ══════════════════════════════════════════════════════════════

case "${1:-help}" in
    new)       cmd_new ;;
    start)     cmd_start "${2:-30}" ;;
    zone)      cmd_zone "${2:-fullstack}" "${3:-}" ;;
    parallel)  shift; cmd_parallel "$@" ;;
    stop)      cmd_stop ;;
    status)    cmd_status ;;
    watch)     cmd_watch ;;
    logs)      cmd_logs "${2:-50}" ;;
    dashboard) cmd_dashboard ;;
    reset)     cmd_reset ;;
    edit)      cmd_edit ;;
    help|-h|--help) cmd_help ;;
    *)
        echo -e "${R}Unknown: $1${N}"
        echo "Run './ralph help'"
        exit 1
        ;;
esac
