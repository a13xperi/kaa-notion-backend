#!/bin/bash
#
# RALPH - Autonomous Loop for Claude Code
# Usage: ./ralph [command] [options]
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RALPH_DIR="${HOME}/.ralph"
RALPH_STATE="${RALPH_DIR}/state.json"
RALPH_LOG="${RALPH_DIR}/ralph.log"
CONFIG_FILE="${SCRIPT_DIR}/.ralph.json"
PROMPT_FILE="${SCRIPT_DIR}/PROMPT.md"
OUTPUT_LOG="${SCRIPT_DIR}/.ralph-output.log"

# Colors
R='\033[0;31m' G='\033[0;32m' Y='\033[1;33m' B='\033[0;34m' C='\033[0;36m' W='\033[1;37m' N='\033[0m'

mkdir -p "${RALPH_DIR}"

# Initialize state if needed
[[ -f "${RALPH_STATE}" ]] || echo '{"iteration":0,"status":"idle","started":""}' > "${RALPH_STATE}"

# Initialize config if needed
[[ -f "${CONFIG_FILE}" ]] || cat > "${CONFIG_FILE}" << 'CONF'
{
  "maxIterations": 30,
  "completionPromise": "RALPH_COMPLETE",
  "model": "claude-sonnet-4-20250514"
}
CONF

banner() {
    echo -e "${C}"
    cat << 'EOF'
  ____      _     _     ____  _   _
 |  _ \    / \   | |   |  _ \| | | |
 | |_) |  / _ \  | |   | |_) | |_| |
 |  _ <  / ___ \ | |___|  __/|  _  |
 |_| \_\/_/   \_\|_____|_|   |_| |_|

EOF
    echo -e "${N}  Autonomous Loop for Claude Code"
    echo ""
}

status() {
    local iter=$(jq -r '.iteration // 0' "${RALPH_STATE}" 2>/dev/null || echo 0)
    local status=$(jq -r '.status // "idle"' "${RALPH_STATE}" 2>/dev/null || echo "idle")
    local max=$(jq -r '.maxIterations // 30' "${CONFIG_FILE}" 2>/dev/null || echo 30)
    local last=$(jq -r '.lastUpdate // "-"' "${RALPH_STATE}" 2>/dev/null || echo "-")

    echo -e "${W}=== RALPH STATUS ===${N}"
    echo ""

    case "${status}" in
        running) echo -e "  Status:     ${G}RUNNING${N}" ;;
        complete) echo -e "  Status:     ${G}COMPLETE${N}" ;;
        stopped) echo -e "  Status:     ${Y}STOPPED${N}" ;;
        max_iterations) echo -e "  Status:     ${Y}MAX ITERATIONS${N}" ;;
        *) echo -e "  Status:     ${B}IDLE${N}" ;;
    esac

    echo -e "  Iteration:  ${W}${iter}${N} / ${max}"
    echo -e "  Last:       ${last}"
    echo ""

    if [[ -f "${PROMPT_FILE}" ]]; then
        echo -e "  ${G}PROMPT.md${N}    Ready"
    else
        echo -e "  ${R}PROMPT.md${N}    Missing!"
    fi

    if [[ -f "${OUTPUT_LOG}" ]]; then
        echo ""
        echo -e "${W}Recent Activity:${N}"
        tail -5 "${OUTPUT_LOG}" 2>/dev/null | sed 's/^/  /'
    fi
}

start() {
    local max="${1:-30}"

    banner

    if [[ ! -f "${PROMPT_FILE}" ]]; then
        echo -e "${R}Error: PROMPT.md not found${N}"
        echo ""
        echo "Create PROMPT.md with your task first."
        echo "Example: ./ralph edit"
        exit 1
    fi

    # Update config
    jq --arg max "${max}" '.maxIterations = ($max | tonumber)' "${CONFIG_FILE}" > "${CONFIG_FILE}.tmp"
    mv "${CONFIG_FILE}.tmp" "${CONFIG_FILE}"

    # Reset state
    echo '{"iteration":0,"status":"running","started":"'"$(date -Iseconds)"'"}' > "${RALPH_STATE}"
    rm -f "${SCRIPT_DIR}/.ralph-stop"
    > "${OUTPUT_LOG}"

    echo -e "${G}Ralph initialized${N}"
    echo ""
    echo -e "  Max iterations: ${W}${max}${N}"
    echo -e "  Prompt:         ${W}PROMPT.md${N}"
    echo ""
    echo -e "${Y}Starting Claude Code...${N}"
    echo ""

    # Read prompt and launch Claude
    local prompt=$(cat "${PROMPT_FILE}")

    # Launch Claude Code with the prompt
    cd "${SCRIPT_DIR}"
    exec claude --dangerously-skip-permissions "${prompt}

---
This is a RALPH autonomous loop. Work continuously on this task.
When fully complete, output: RALPH_COMPLETE"
}

run() {
    local max="${1:-30}"

    banner

    if [[ ! -f "${PROMPT_FILE}" ]]; then
        echo -e "${R}Error: PROMPT.md not found${N}"
        exit 1
    fi

    # Update config
    jq --arg max "${max}" '.maxIterations = ($max | tonumber)' "${CONFIG_FILE}" > "${CONFIG_FILE}.tmp"
    mv "${CONFIG_FILE}.tmp" "${CONFIG_FILE}"

    # Reset state
    echo '{"iteration":0,"status":"running","started":"'"$(date -Iseconds)"'"}' > "${RALPH_STATE}"
    rm -f "${SCRIPT_DIR}/.ralph-stop"
    > "${OUTPUT_LOG}"

    echo -e "${G}Ralph ready${N}"
    echo ""
    echo -e "  Max iterations: ${W}${max}${N}"
    echo ""
    echo -e "${W}Run this in Warp/Terminal:${N}"
    echo ""
    echo -e "  ${C}cd ${SCRIPT_DIR} && claude${N}"
    echo ""
    echo "Then paste your prompt from PROMPT.md"
    echo ""
    echo -e "${Y}Tip: Copy prompt with:${N} cat PROMPT.md | pbcopy"
}

stop() {
    touch "${SCRIPT_DIR}/.ralph-stop"
    jq '.status = "stopped"' "${RALPH_STATE}" > "${RALPH_STATE}.tmp"
    mv "${RALPH_STATE}.tmp" "${RALPH_STATE}"
    echo -e "${Y}Stop signal sent${N}"
    echo "Loop will exit on next iteration."
}

reset() {
    echo '{"iteration":0,"status":"idle","started":""}' > "${RALPH_STATE}"
    rm -f "${SCRIPT_DIR}/.ralph-stop" "${OUTPUT_LOG}"
    echo -e "${G}Ralph reset${N}"
}

logs() {
    if [[ -f "${RALPH_LOG}" ]]; then
        echo -e "${W}=== RALPH LOGS ===${N}"
        tail -${1:-50} "${RALPH_LOG}"
    else
        echo "No logs yet"
    fi
}

watch_logs() {
    echo -e "${W}=== WATCHING RALPH (Ctrl+C to exit) ===${N}"
    echo ""
    tail -f "${OUTPUT_LOG}" 2>/dev/null || echo "Waiting for activity..."
}

edit() {
    if command -v cursor &>/dev/null; then
        cursor "${PROMPT_FILE}"
    elif [[ -n "${EDITOR:-}" ]]; then
        "${EDITOR}" "${PROMPT_FILE}"
    else
        nano "${PROMPT_FILE}" 2>/dev/null || vi "${PROMPT_FILE}"
    fi
}

help() {
    banner
    echo -e "${W}COMMANDS${N}"
    echo ""
    echo -e "  ${C}./ralph start [N]${N}   Start loop with N iterations (default: 30)"
    echo -e "  ${C}./ralph run [N]${N}     Initialize and show run command"
    echo -e "  ${C}./ralph stop${N}        Stop the loop gracefully"
    echo -e "  ${C}./ralph status${N}      Show current status"
    echo -e "  ${C}./ralph watch${N}       Watch loop activity live"
    echo -e "  ${C}./ralph logs [N]${N}    Show last N log entries"
    echo -e "  ${C}./ralph reset${N}       Reset to idle state"
    echo -e "  ${C}./ralph edit${N}        Edit PROMPT.md in Cursor"
    echo ""
    echo -e "${W}QUICK START${N}"
    echo ""
    echo "  1. Edit your task:     ./ralph edit"
    echo "  2. Start the loop:     ./ralph start 30"
    echo ""
    echo -e "${W}FILES${N}"
    echo ""
    echo "  PROMPT.md        Your task instructions"
    echo "  .ralph.json      Configuration"
    echo "  .ralph-output.log   Activity log"
    echo ""
}

# Main
case "${1:-help}" in
    start)   start "${2:-30}" ;;
    run)     run "${2:-30}" ;;
    stop)    stop ;;
    status)  status ;;
    watch)   watch_logs ;;
    logs)    logs "${2:-50}" ;;
    reset)   reset ;;
    edit)    edit ;;
    help|-h|--help) help ;;
    *)
        echo -e "${R}Unknown command: $1${N}"
        echo "Run './ralph help' for usage"
        exit 1
        ;;
esac
