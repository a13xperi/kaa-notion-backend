#!/bin/bash
#
# RALPH - Production-Grade Autonomous Loop for Claude Code
# Multi-agent orchestrator with circuit breakers, rollback, and safety mechanisms
#
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
RALPH_LOCAL="${SCRIPT_DIR}/.ralph"
RALPH_GLOBAL="${HOME}/.ralph"
RALPH_STATE="${RALPH_GLOBAL}/state.json"
RALPH_LOG="${RALPH_GLOBAL}/ralph.log"
RALPH_METRICS="${RALPH_GLOBAL}/metrics.json"
CONFIG_FILE="${SCRIPT_DIR}/.ralph.json"
PROMPT_FILE="${SCRIPT_DIR}/PROMPT.md"
ACTIVITY_LOG="${SCRIPT_DIR}/.ralph-output.log"
CHECKPOINT_DIR="${RALPH_GLOBAL}/checkpoints"
GIT_STASH_PREFIX="ralph-checkpoint"

# Colors
R='\033[0;31m' G='\033[0;32m' Y='\033[1;33m' B='\033[0;34m'
C='\033[0;36m' M='\033[0;35m' W='\033[1;37m' N='\033[0m' DIM='\033[2m'
BOLD='\033[1m'

# Ensure directories exist
mkdir -p "${RALPH_GLOBAL}" "${RALPH_LOCAL}/prompts" "${RALPH_LOCAL}/queue" "${CHECKPOINT_DIR}"

# ══════════════════════════════════════════════════════════════════════════════
# STATE MANAGEMENT
# ══════════════════════════════════════════════════════════════════════════════

init_state() {
    if [[ ! -f "${RALPH_STATE}" ]] || [[ ! -s "${RALPH_STATE}" ]]; then
        cat > "${RALPH_STATE}" << 'EOF'
{
  "iteration": 0,
  "status": "idle",
  "started": null,
  "lastUpdate": null,
  "circuitBreaker": {
    "state": "closed",
    "noProgressCount": 0,
    "sameErrorCount": 0,
    "testOnlyCount": 0,
    "failureCount": 0,
    "tripReason": null
  },
  "session": {
    "totalIterations": 0,
    "totalCost": 0,
    "gitCheckpoint": null
  }
}
EOF
    fi
}

init_state

get_state() {
    local path="$1"
    local default="${2:-}"
    jq -r "${path} // empty" "${RALPH_STATE}" 2>/dev/null || echo "${default}"
}

set_state() {
    local updates="$1"
    local tmp="${RALPH_STATE}.tmp.$$"
    if jq ". * ${updates}" "${RALPH_STATE}" > "${tmp}" 2>/dev/null; then
        mv "${tmp}" "${RALPH_STATE}"
    else
        rm -f "${tmp}"
    fi
}

get_config() {
    local path="$1"
    local default="$2"
    if [[ -f "${CONFIG_FILE}" ]]; then
        jq -r "${path} // empty" "${CONFIG_FILE}" 2>/dev/null || echo "${default}"
    else
        echo "${default}"
    fi
}

# ══════════════════════════════════════════════════════════════════════════════
# UI COMPONENTS
# ══════════════════════════════════════════════════════════════════════════════

banner() {
    echo -e "${C}"
    cat << 'EOF'
  ╦═╗╔═╗╦  ╔═╗╦ ╦
  ╠╦╝╠═╣║  ╠═╝╠═╣
  ╩╚═╩ ╩╩═╝╩  ╩ ╩
EOF
    echo -e "${N}  ${DIM}Production-Grade Autonomous Loop${N}"
    echo ""
}

divider() { echo -e "${DIM}────────────────────────────────────────────────${N}"; }

ok()   { echo -e "  ${G}✓${N} $*"; }
warn() { echo -e "  ${Y}!${N} $*"; }
err()  { echo -e "  ${R}✗${N} $*"; }
info() { echo -e "  ${B}○${N} $*"; }

# ══════════════════════════════════════════════════════════════════════════════
# PRE-FLIGHT CHECKS
# ══════════════════════════════════════════════════════════════════════════════

preflight_check() {
    local errors=0

    echo -e "${W}PRE-FLIGHT CHECKS${N}"
    divider

    # Check PROMPT.md exists
    if [[ -f "${PROMPT_FILE}" ]]; then
        ok "PROMPT.md exists"
    else
        err "PROMPT.md missing - create with ./ralph new"
        errors=$((errors + 1))
    fi

    # Check PROMPT.md has completion promise
    if [[ -f "${PROMPT_FILE}" ]] && grep -q "RALPH_COMPLETE" "${PROMPT_FILE}"; then
        ok "Completion promise found"
    elif [[ -f "${PROMPT_FILE}" ]]; then
        warn "No RALPH_COMPLETE in prompt (will use default)"
    fi

    # Check git status
    if git rev-parse --git-dir >/dev/null 2>&1; then
        ok "Git repository detected"
        local dirty=$(git status --porcelain 2>/dev/null | wc -l)
        if [[ ${dirty} -gt 0 ]]; then
            warn "Uncommitted changes (${dirty} files) - consider committing first"
        else
            ok "Working directory clean"
        fi
    else
        warn "Not a git repository - rollback unavailable"
    fi

    # Check claude command
    if command -v claude &>/dev/null; then
        ok "Claude Code CLI found"
    else
        err "Claude Code CLI not found"
        errors=$((errors + 1))
    fi

    # Check jq
    if command -v jq &>/dev/null; then
        ok "jq installed"
    else
        err "jq required but not found"
        errors=$((errors + 1))
    fi

    # Check disk space (need at least 100MB)
    local available=$(df -m "${SCRIPT_DIR}" 2>/dev/null | tail -1 | awk '{print $4}')
    if [[ -n "${available}" ]] && [[ ${available} -gt 100 ]]; then
        ok "Disk space OK (${available}MB available)"
    else
        warn "Low disk space"
    fi

    # Check for existing loop
    local status=$(get_state '.status' 'idle')
    if [[ "${status}" == "running" ]]; then
        warn "Previous loop may still be running"
    else
        ok "No active loop"
    fi

    echo ""

    if [[ ${errors} -gt 0 ]]; then
        echo -e "${R}Pre-flight failed with ${errors} error(s)${N}"
        return 1
    fi

    echo -e "${G}All checks passed${N}"
    return 0
}

# ══════════════════════════════════════════════════════════════════════════════
# GIT ROLLBACK / UNDO STACK
# ══════════════════════════════════════════════════════════════════════════════

create_git_checkpoint() {
    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        return 0
    fi

    local checkpoint_name="${GIT_STASH_PREFIX}-$(date +%Y%m%d-%H%M%S)"
    local current_commit=$(git rev-parse HEAD 2>/dev/null || echo "")

    # Store current commit for rollback
    set_state "{\"session\": {\"gitCheckpoint\": \"${current_commit}\"}}"

    # Create a lightweight tag for easy recovery
    git tag -f "ralph-start-$(date +%Y%m%d-%H%M%S)" HEAD 2>/dev/null || true

    echo "${current_commit}"
}

rollback_to_checkpoint() {
    local checkpoint=$(get_state '.session.gitCheckpoint' '')

    if [[ -z "${checkpoint}" ]]; then
        echo -e "${R}No checkpoint found${N}"
        return 1
    fi

    if ! git rev-parse --git-dir >/dev/null 2>&1; then
        echo -e "${R}Not a git repository${N}"
        return 1
    fi

    echo -e "${Y}Rolling back to checkpoint: ${checkpoint:0:8}${N}"
    echo ""

    # Show what will be undone
    echo -e "${W}Changes to be reverted:${N}"
    git diff --stat "${checkpoint}" HEAD 2>/dev/null | head -20

    echo ""
    read -p "Proceed with rollback? [y/N] " confirm

    if [[ "${confirm}" =~ ^[Yy]$ ]]; then
        git reset --hard "${checkpoint}"
        echo -e "${G}Rolled back successfully${N}"
    else
        echo "Rollback cancelled"
    fi
}

# ══════════════════════════════════════════════════════════════════════════════
# COST TRACKING
# ══════════════════════════════════════════════════════════════════════════════

estimate_cost() {
    local iterations="$1"
    local cost_per_iter=$(get_config '.costs.estimatedPerIteration' '1.50')
    echo "scale=2; ${iterations} * ${cost_per_iter}" | bc 2>/dev/null || echo "?"
}

check_budget() {
    local current_cost=$(get_state '.session.totalCost' '0')
    local budget_warning=$(get_config '.costs.budgetWarningAt' '50')
    local budget_stop=$(get_config '.costs.budgetStopAt' '100')

    if (( $(echo "${current_cost} >= ${budget_stop}" | bc -l 2>/dev/null || echo 0) )); then
        echo "exceeded"
        return 1
    elif (( $(echo "${current_cost} >= ${budget_warning}" | bc -l 2>/dev/null || echo 0) )); then
        echo "warning"
        return 0
    else
        echo "ok"
        return 0
    fi
}

# ══════════════════════════════════════════════════════════════════════════════
# HEALTH CHECK
# ══════════════════════════════════════════════════════════════════════════════

health_check() {
    echo -e "${W}HEALTH CHECK${N}"
    divider

    # Circuit breaker state
    local cb_state=$(get_state '.circuitBreaker.state' 'closed')
    local cb_reason=$(get_state '.circuitBreaker.tripReason' '')

    if [[ "${cb_state}" == "closed" ]]; then
        ok "Circuit breaker: ${G}CLOSED${N}"
    else
        err "Circuit breaker: ${R}OPEN${N} (${cb_reason})"
    fi

    # Counter states
    local no_progress=$(get_state '.circuitBreaker.noProgressCount' '0')
    local same_error=$(get_state '.circuitBreaker.sameErrorCount' '0')
    local test_only=$(get_state '.circuitBreaker.testOnlyCount' '0')

    if [[ ${no_progress} -gt 0 ]]; then
        warn "No progress counter: ${no_progress}/4"
    else
        ok "Progress: Making changes"
    fi

    if [[ ${same_error} -gt 0 ]]; then
        warn "Same error counter: ${same_error}/5"
    else
        ok "Errors: No repeated errors"
    fi

    if [[ ${test_only} -gt 0 ]]; then
        warn "Test-only counter: ${test_only}/5"
    else
        ok "Activity: Making code changes"
    fi

    # Budget
    local budget_status=$(check_budget)
    case "${budget_status}" in
        exceeded) err "Budget: ${R}EXCEEDED${N}" ;;
        warning)  warn "Budget: Approaching limit" ;;
        ok)       ok "Budget: Within limits" ;;
    esac

    echo ""
}

# ══════════════════════════════════════════════════════════════════════════════
# PROMPT GENERATION
# ══════════════════════════════════════════════════════════════════════════════

generate_prompt() {
    local zone="$1"
    local task="$2"

    local template="${RALPH_LOCAL}/prompts/${zone}.md"
    [[ -f "${template}" ]] || template="${RALPH_LOCAL}/prompts/fullstack.md"

    if [[ -f "${template}" ]]; then
        sed -e "s|{{TASK}}|${task}|g" "${template}"
    else
        cat << EOF
# Task: ${task}

## Zone: ${zone}

## Success Criteria
- [ ] All requirements implemented
- [ ] Tests pass: npm test
- [ ] No TypeScript errors

## Workflow
1. Make incremental changes
2. Test after each change
3. Fix errors before proceeding

When ALL criteria met, output: RALPH_COMPLETE
EOF
    fi
}

# ══════════════════════════════════════════════════════════════════════════════
# COMMANDS
# ══════════════════════════════════════════════════════════════════════════════

cmd_new() {
    banner

    echo -e "${W}PLATFORM ZONES${N}"
    divider
    echo -e "  ${C}Web/Backend${N}"
    echo -e "    ${C}1${N}) frontend      - React, TypeScript, Tailwind"
    echo -e "    ${C}2${N}) backend       - Express, Prisma, Node.js"
    echo -e "    ${C}3${N}) database      - PostgreSQL, migrations"
    echo -e "    ${C}4${N}) fullstack     - End-to-end features"
    echo ""
    echo -e "  ${C}Mobile${N}"
    echo -e "    ${C}5${N}) react-native  - React Native, Expo, TypeScript"
    echo -e "    ${C}6${N}) flutter       - Flutter, Dart, Riverpod"
    echo -e "    ${C}7${N}) ios           - Swift, SwiftUI, XCTest"
    echo -e "    ${C}8${N}) android       - Kotlin, Jetpack Compose"
    echo ""
    echo -e "  ${C}Testing${N}"
    echo -e "    ${C}9${N}) tests         - Jest, Playwright"
    echo -e "    ${C}10${N}) e2e          - E2E Testing Loop (Playwright/Detox/Maestro)"
    echo ""

    read -p "Zone [1-10]: " zone_num
    case "${zone_num}" in
        1) zone="frontend" ;;
        2) zone="backend" ;;
        3) zone="database" ;;
        4) zone="fullstack" ;;
        5) zone="react-native" ;;
        6) zone="flutter" ;;
        7) zone="ios" ;;
        8) zone="android" ;;
        9) zone="tests" ;;
        10) zone="e2e" ;;
        *) zone="fullstack" ;;
    esac

    echo ""
    read -p "Task description: " task_desc
    echo ""
    read -p "Max iterations [30]: " max_iter
    max_iter="${max_iter:-30}"

    generate_prompt "${zone}" "${task_desc}" > "${PROMPT_FILE}"

    # Estimate cost
    local est_cost=$(estimate_cost "${max_iter}")

    echo ""
    echo -e "${G}Task created${N}"
    divider
    echo -e "  Zone:       ${C}${zone}${N}"
    echo -e "  Iterations: ${W}${max_iter}${N}"
    echo -e "  Est. cost:  ${Y}\$${est_cost}${N}"
    echo ""
    echo -e "${W}Next:${N}"
    echo "  1. Review:  ./ralph edit"
    echo "  2. Start:   ./ralph start ${max_iter}"
}

cmd_start() {
    local max="${1:-30}"
    local skip_checks="${2:-}"

    banner

    # Pre-flight checks (can skip with --force)
    if [[ "${skip_checks}" != "--force" ]]; then
        if ! preflight_check; then
            echo ""
            echo "Use './ralph start ${max} --force' to skip checks"
            exit 1
        fi
        echo ""
    fi

    # Create git checkpoint
    echo -e "${W}CREATING CHECKPOINT${N}"
    divider
    local checkpoint=$(create_git_checkpoint)
    if [[ -n "${checkpoint}" ]]; then
        ok "Git checkpoint: ${checkpoint:0:8}"
    else
        info "Git checkpoint: Skipped (not a git repo)"
    fi

    # Estimate cost
    local est_cost=$(estimate_cost "${max}")
    info "Estimated cost: \$${est_cost}"
    echo ""

    # Update config
    cat > "${CONFIG_FILE}" << EOF
{
  "maxIterations": ${max},
  "completionPromise": "RALPH_COMPLETE",
  "started": "$(date -Iseconds)",
  "circuitBreaker": {
    "noProgressThreshold": 4,
    "sameErrorThreshold": 5,
    "testOnlyThreshold": 5,
    "consecutiveFailures": 3
  },
  "costs": {
    "estimatedPerIteration": 1.50,
    "budgetWarningAt": 50,
    "budgetStopAt": 100
  }
}
EOF

    # Reset state
    set_state '{
        "iteration": 0,
        "status": "running",
        "started": "'"$(date -Iseconds)"'",
        "circuitBreaker": {
            "state": "closed",
            "noProgressCount": 0,
            "sameErrorCount": 0,
            "testOnlyCount": 0,
            "failureCount": 0,
            "tripReason": null
        }
    }'

    rm -f "${SCRIPT_DIR}/.ralph-stop" "${ACTIVITY_LOG}"
    touch "${ACTIVITY_LOG}"

    # Show task preview
    echo -e "${W}TASK${N}"
    divider
    head -10 "${PROMPT_FILE}" | sed 's/^/  /'
    echo -e "  ${DIM}...${N}"
    echo ""

    echo -e "${G}LAUNCHING${N}"
    divider
    echo -e "  Iterations: ${W}${max}${N}"
    echo -e "  Monitor:    ${C}./ralph watch${N}"
    echo -e "  Stop:       ${C}./ralph stop${N}"
    echo -e "  Rollback:   ${C}./ralph rollback${N}"
    echo ""

    local prompt=$(cat "${PROMPT_FILE}")

    cd "${SCRIPT_DIR}"
    exec claude --dangerously-skip-permissions "${prompt}

════════════════════════════════════════════════════════════════════════════════
RALPH AUTONOMOUS LOOP
════════════════════════════════════════════════════════════════════════════════

Work continuously on this task. Your progress is automatically saved.

IMPORTANT:
• Make incremental, testable changes
• Run tests after each change: npm test
• Fix errors before proceeding
• When ALL success criteria are met, output exactly: RALPH_COMPLETE

The loop will continue until you output RALPH_COMPLETE or reach max iterations.
════════════════════════════════════════════════════════════════════════════════"
}

cmd_status() {
    banner

    local iter=$(get_state '.iteration' '0')
    local status=$(get_state '.status' 'idle')
    local max=$(get_config '.maxIterations' '30')
    local started=$(get_state '.started' '-')

    echo -e "${W}STATUS${N}"
    divider

    # Status indicator
    case "${status}" in
        running)        echo -e "  State:      ${G}● RUNNING${N}" ;;
        complete)       echo -e "  State:      ${G}✓ COMPLETE${N}" ;;
        stopped)        echo -e "  State:      ${Y}■ STOPPED${N}" ;;
        max_iterations) echo -e "  State:      ${Y}! MAX ITERATIONS${N}" ;;
        circuit_breaker) echo -e "  State:      ${R}⚡ CIRCUIT BREAKER${N}" ;;
        *)              echo -e "  State:      ${DIM}○ IDLE${N}" ;;
    esac

    echo -e "  Iteration:  ${W}${iter}${N} / ${max}"
    echo -e "  Started:    ${DIM}${started}${N}"
    echo ""

    # Circuit breaker details
    local cb_state=$(get_state '.circuitBreaker.state' 'closed')
    echo -e "${W}CIRCUIT BREAKER${N}"
    divider

    if [[ "${cb_state}" == "closed" ]]; then
        echo -e "  State: ${G}CLOSED${N} (healthy)"
    else
        local reason=$(get_state '.circuitBreaker.tripReason' 'unknown')
        echo -e "  State: ${R}OPEN${N} (${reason})"
    fi

    local no_progress=$(get_state '.circuitBreaker.noProgressCount' '0')
    local same_error=$(get_state '.circuitBreaker.sameErrorCount' '0')
    local test_only=$(get_state '.circuitBreaker.testOnlyCount' '0')

    echo -e "  No Progress:  ${no_progress}/4"
    echo -e "  Same Error:   ${same_error}/5"
    echo -e "  Test Only:    ${test_only}/5"
    echo ""

    # Checkpoint
    local checkpoint=$(get_state '.session.gitCheckpoint' '')
    if [[ -n "${checkpoint}" ]]; then
        echo -e "${W}RECOVERY${N}"
        divider
        echo -e "  Checkpoint: ${checkpoint:0:8}"
        echo -e "  Rollback:   ${C}./ralph rollback${N}"
        echo ""
    fi

    # Recent activity
    if [[ -f "${ACTIVITY_LOG}" ]] && [[ -s "${ACTIVITY_LOG}" ]]; then
        echo -e "${W}RECENT ACTIVITY${N}"
        divider
        tail -5 "${ACTIVITY_LOG}" | sed 's/^/  /'
        echo ""
    fi
}

cmd_watch() {
    banner
    echo -e "${W}WATCHING${N} ${DIM}(Ctrl+C to exit)${N}"
    divider
    echo ""

    if [[ -f "${ACTIVITY_LOG}" ]]; then
        tail -f "${ACTIVITY_LOG}" 2>/dev/null
    else
        echo "Waiting for activity..."
        while [[ ! -f "${ACTIVITY_LOG}" ]]; do sleep 1; done
        tail -f "${ACTIVITY_LOG}"
    fi
}

cmd_stop() {
    touch "${SCRIPT_DIR}/.ralph-stop"
    set_state '{"status": "stopped"}'
    echo -e "${Y}Stop signal sent${N}"
    echo "Loop will exit on next iteration."
}

cmd_reset() {
    cat > "${RALPH_STATE}" << 'EOF'
{
  "iteration": 0,
  "status": "idle",
  "started": null,
  "circuitBreaker": {"state": "closed", "noProgressCount": 0, "sameErrorCount": 0, "testOnlyCount": 0},
  "session": {"totalIterations": 0, "totalCost": 0, "gitCheckpoint": null}
}
EOF
    rm -f "${SCRIPT_DIR}/.ralph-stop" "${ACTIVITY_LOG}"
    echo -e "${G}Ralph reset${N}"
}

cmd_rollback() {
    banner
    echo -e "${W}ROLLBACK${N}"
    divider
    rollback_to_checkpoint
}

cmd_health() {
    banner
    health_check
}

cmd_zone() {
    local zone="${1:-fullstack}"
    local task="${2:-Implement improvements}"
    generate_prompt "${zone}" "${task}" > "${PROMPT_FILE}"
    echo -e "${G}Zone prompt created: ${zone}${N}"
}

cmd_edit() {
    if command -v cursor &>/dev/null; then
        cursor "${PROMPT_FILE}"
    elif command -v code &>/dev/null; then
        code "${PROMPT_FILE}"
    elif [[ -n "${EDITOR:-}" ]]; then
        "${EDITOR}" "${PROMPT_FILE}"
    else
        nano "${PROMPT_FILE}" 2>/dev/null || vi "${PROMPT_FILE}"
    fi
}

cmd_logs() {
    local n="${1:-50}"
    if [[ -f "${RALPH_LOG}" ]]; then
        echo -e "${W}LOGS${N} ${DIM}(last ${n})${N}"
        divider
        tail -"${n}" "${RALPH_LOG}"
    else
        echo "No logs yet"
    fi
}

cmd_dashboard() {
    watch -n 2 -c "./ralph status"
}

cmd_preflight() {
    banner
    preflight_check
}

# ══════════════════════════════════════════════════════════════════════════════
# MOBILE & E2E COMMANDS
# ══════════════════════════════════════════════════════════════════════════════

cmd_devices() {
    banner
    echo -e "${W}DEVICE & SIMULATOR STATUS${N}"
    divider
    echo ""

    # iOS Simulators
    echo -e "${C}iOS Simulators${N}"
    if command -v xcrun &>/dev/null; then
        local booted=$(xcrun simctl list devices booted 2>/dev/null | grep -c "Booted" || echo "0")
        if [[ ${booted} -gt 0 ]]; then
            ok "Booted simulators: ${booted}"
            xcrun simctl list devices booted 2>/dev/null | grep "Booted" | sed 's/^/      /'
        else
            info "No simulators running"
        fi
        echo ""

        echo -e "  ${DIM}Available:${N}"
        xcrun simctl list devices available 2>/dev/null | grep -E "iPhone|iPad" | head -5 | sed 's/^/      /'
        echo -e "      ${DIM}... (run 'xcrun simctl list devices' for all)${N}"
    else
        warn "Xcode tools not installed (xcrun not found)"
    fi
    echo ""

    # Android Emulators
    echo -e "${C}Android Emulators${N}"
    if command -v emulator &>/dev/null || [[ -d "${ANDROID_HOME:-$HOME/Android/Sdk}/emulator" ]]; then
        local emu_path="${ANDROID_HOME:-$HOME/Android/Sdk}/emulator/emulator"

        # Check running emulators
        if command -v adb &>/dev/null; then
            local running=$(adb devices 2>/dev/null | grep -c "emulator" || echo "0")
            if [[ ${running} -gt 0 ]]; then
                ok "Running emulators: ${running}"
                adb devices 2>/dev/null | grep "emulator" | sed 's/^/      /'
            else
                info "No emulators running"
            fi
        fi
        echo ""

        # List available AVDs
        if [[ -x "${emu_path}" ]]; then
            echo -e "  ${DIM}Available AVDs:${N}"
            "${emu_path}" -list-avds 2>/dev/null | head -5 | sed 's/^/      /'
        fi
    else
        warn "Android SDK not found"
    fi
    echo ""

    # Physical devices
    echo -e "${C}Physical Devices${N}"
    if command -v adb &>/dev/null; then
        local physical=$(adb devices 2>/dev/null | grep -v "emulator" | grep "device$" | wc -l || echo "0")
        if [[ ${physical} -gt 0 ]]; then
            ok "Connected Android devices: ${physical}"
            adb devices 2>/dev/null | grep "device$" | grep -v "emulator" | sed 's/^/      /'
        else
            info "No Android devices connected"
        fi
    fi
    if command -v idevice_id &>/dev/null; then
        local ios_devices=$(idevice_id -l 2>/dev/null | wc -l || echo "0")
        if [[ ${ios_devices} -gt 0 ]]; then
            ok "Connected iOS devices: ${ios_devices}"
        fi
    fi
    echo ""

    # Quick commands
    echo -e "${W}QUICK COMMANDS${N}"
    divider
    echo -e "  ${C}iOS${N}"
    echo "    Boot:   xcrun simctl boot 'iPhone 15'"
    echo "    List:   xcrun simctl list devices"
    echo ""
    echo -e "  ${C}Android${N}"
    echo "    Boot:   emulator -avd Pixel_7"
    echo "    List:   emulator -list-avds"
    echo ""
}

cmd_e2e() {
    local target="${1:-all}"
    local max="${2:-20}"

    banner
    echo -e "${W}E2E CONTINUOUS TEST LOOP${N}"
    divider
    echo ""

    # Pre-flight for E2E
    echo -e "${W}E2E PRE-FLIGHT${N}"
    divider
    local errors=0

    # Check test frameworks
    if [[ -f "playwright.config.ts" ]] || [[ -f "playwright.config.js" ]]; then
        ok "Playwright config found"
    else
        info "No Playwright config (web E2E may not work)"
    fi

    if [[ -f ".detoxrc.js" ]] || [[ -f ".detoxrc.json" ]]; then
        ok "Detox config found"
    else
        info "No Detox config (React Native E2E may not work)"
    fi

    if [[ -d ".maestro" ]]; then
        ok "Maestro flows found"
    else
        info "No .maestro directory (mobile E2E may not work)"
    fi

    # Check if target tests exist
    case "${target}" in
        web|playwright)
            if ! command -v npx &>/dev/null || ! npx playwright --version &>/dev/null 2>&1; then
                err "Playwright not installed"
                errors=$((errors + 1))
            fi
            ;;
        mobile|detox)
            if ! command -v detox &>/dev/null; then
                warn "Detox CLI not found globally (may use npx)"
            fi
            ;;
        maestro)
            if ! command -v maestro &>/dev/null; then
                err "Maestro not installed"
                errors=$((errors + 1))
            fi
            ;;
    esac

    echo ""

    if [[ ${errors} -gt 0 ]]; then
        echo -e "${R}E2E pre-flight failed${N}"
        return 1
    fi

    # Generate E2E prompt
    local e2e_prompt="${RALPH_LOCAL}/prompts/e2e.md"
    if [[ -f "${e2e_prompt}" ]]; then
        cat "${e2e_prompt}" | \
            sed "s|{{TASK}}|Run ${target} E2E tests continuously until all pass|g" | \
            sed "s|{{REQUIREMENTS}}|Target: ${target}, Max iterations: ${max}|g" \
            > "${PROMPT_FILE}"
    else
        cat > "${PROMPT_FILE}" << EOF
# E2E Testing Loop

## Target: ${target}

## Task
Run E2E tests continuously. When tests fail:
1. Analyze the failure
2. Fix the APPLICATION code (not the tests unless tests are wrong)
3. Re-run tests
4. Repeat until all pass

## Test Commands
$(case "${target}" in
    web|playwright)   echo "- npx playwright test" ;;
    mobile|detox)     echo "- detox test -c ios.sim.debug" ;;
    maestro)          echo "- maestro test .maestro/" ;;
    all|*)            echo "- npx playwright test (web)
- detox test (React Native)
- maestro test .maestro/ (mobile)" ;;
esac)

## Success Criteria
- [ ] All ${target} E2E tests pass
- [ ] Run tests 3x to verify no flakiness
- [ ] No regressions introduced

When ALL tests pass consistently (3 runs), output: RALPH_COMPLETE
EOF
    fi

    echo -e "${G}E2E loop configured${N}"
    echo -e "  Target:     ${C}${target}${N}"
    echo -e "  Iterations: ${W}${max}${N}"
    echo ""
    echo -e "${W}Starting E2E loop...${N}"
    echo ""

    # Start the loop
    cmd_start "${max}" ""
}

cmd_comprehensive() {
    local max="${1:-50}"
    local area="${2:-all}"

    banner
    echo -e "${W}COMPREHENSIVE TESTING LOOP${N}"
    divider
    echo ""
    echo -e "This will run a ${C}continuous improvement loop${N} covering:"
    echo ""
    echo "  Phase 1: Unit Tests (100% pass required)"
    echo "  Phase 2: Integration Tests (100% pass required)"
    echo "  Phase 3: E2E Critical Paths (100% pass required)"
    echo "  Phase 4: E2E Full Suite (95%+ pass required)"
    echo "  Phase 5: Edge Cases (100% pass required)"
    echo "  Phase 6: Accessibility (100% pass required)"
    echo "  Phase 7: Performance (thresholds required)"
    echo "  Phase 8: Final Verification (3 consecutive passes)"
    echo ""

    # Show test areas
    echo -e "${W}TEST AREAS${N}"
    divider
    case "${area}" in
        auth|authentication)
            echo "  Target: Authentication only"
            local grep_filter="@auth"
            ;;
        pay|payments)
            echo "  Target: Payments only"
            local grep_filter="@payment"
            ;;
        onboard|onboarding)
            echo "  Target: Onboarding only"
            local grep_filter="@onboarding"
            ;;
        msg|messaging)
            echo "  Target: Messaging only"
            local grep_filter="@messaging"
            ;;
        all|*)
            echo "  Target: ALL test areas"
            echo ""
            echo "  - Authentication (login, OAuth, MFA, sessions)"
            echo "  - Payments (cards, subscriptions, refunds)"
            echo "  - Onboarding (registration, wizard, invites)"
            echo "  - Messaging (chat, notifications, files)"
            echo "  - Core Features (dashboard, CRUD, search)"
            echo "  - Accessibility (keyboard, screen reader)"
            echo "  - Performance (load times, API response)"
            echo "  - Security (XSS, CSRF, injection)"
            local grep_filter=""
            ;;
    esac
    echo ""

    # Pre-flight
    echo -e "${W}PRE-FLIGHT CHECKS${N}"
    divider
    local errors=0

    if [[ -f "package.json" ]] && grep -q '"test"' package.json 2>/dev/null; then
        ok "Unit test script found"
    else
        warn "No unit test script in package.json"
    fi

    if [[ -f "playwright.config.ts" ]] || [[ -f "playwright.config.js" ]]; then
        ok "Playwright configured"
    else
        warn "No Playwright config"
    fi

    if [[ -d ".ralph/tests" ]]; then
        ok "Test matrix found"
    else
        info "No test matrix (will use default)"
    fi

    echo ""

    # Generate comprehensive prompt
    local prompt_file="${RALPH_LOCAL}/prompts/comprehensive-e2e.md"
    if [[ -f "${prompt_file}" ]]; then
        cat "${prompt_file}" | \
            sed "s|{{TASK}}|Run comprehensive testing loop for: ${area}|g" | \
            sed "s|{{REQUIREMENTS}}|Area: ${area}, Max iterations: ${max}, Grep filter: ${grep_filter:-none}|g" \
            > "${PROMPT_FILE}"
    else
        # Fallback comprehensive prompt
        cat > "${PROMPT_FILE}" << 'COMPREHENSIVE_EOF'
# Comprehensive Testing Task

## Objective
Run a CONTINUOUS IMPROVEMENT loop testing all critical paths, edge cases, and user journeys.

## Test Phases

### Phase 1: Unit Tests
```bash
npm test
```
- Must achieve 100% pass rate
- Fix any failing tests before proceeding

### Phase 2: E2E Critical Paths
```bash
npx playwright test --grep @critical
```
- Test all authentication flows
- Test all payment flows
- Test all onboarding flows
- Test all messaging flows

### Phase 3: Edge Cases
```bash
npx playwright test --grep @edge
```
- Empty inputs, max length, special chars
- Network failures, timeouts
- Concurrent operations
- Error handling

### Phase 4: Full Suite
```bash
npx playwright test
```
- All tests must pass
- Run 3x to verify no flakiness

## Areas to Cover

### Authentication
- Email/password login
- OAuth (Google, Apple, Microsoft)
- MFA (TOTP, SMS, backup codes)
- Password reset
- Session management
- Rate limiting

### Payments
- Credit card payment
- 3D Secure
- Subscriptions (create, upgrade, downgrade, cancel)
- Refunds
- Coupons

### Onboarding
- Registration
- Email verification
- Setup wizard
- Team invitations
- Data import

### Messaging
- Real-time chat
- Notifications
- File sharing
- Offline mode

## Success Criteria
- [ ] All unit tests pass (100%)
- [ ] All E2E tests pass
- [ ] Tests pass 3 consecutive runs
- [ ] No flaky tests

When ALL criteria met, output: RALPH_COMPLETE
COMPREHENSIVE_EOF
    fi

    # Show estimated time
    local est_cost=$(echo "scale=2; ${max} * 1.50" | bc 2>/dev/null || echo "?")
    echo -e "${W}STARTING COMPREHENSIVE TESTING${N}"
    divider
    echo -e "  Iterations: ${W}${max}${N}"
    echo -e "  Est. cost:  ${Y}\$${est_cost}${N}"
    echo -e "  Target:     ${C}${area}${N}"
    echo ""
    echo -e "  ${DIM}This is an extensive test run. It may take a while.${N}"
    echo ""

    # Start the loop
    cmd_start "${max}" ""
}

cmd_test_matrix() {
    banner
    echo -e "${W}TEST MATRIX${N}"
    divider
    echo ""

    local matrix_file="${RALPH_LOCAL}/tests/test-matrix.json"

    if [[ ! -f "${matrix_file}" ]]; then
        err "Test matrix not found: ${matrix_file}"
        return 1
    fi

    # Parse and display test suites
    echo -e "${C}Test Suites:${N}"
    echo ""

    jq -r '.testSuites | to_entries[] | "  \(.key): \(.value.name) [\(.value.priority)]"' "${matrix_file}" 2>/dev/null || \
        echo "  (Unable to parse test matrix)"

    echo ""
    echo -e "${C}Total Scenarios:${N}"

    local total=$(jq '[.testSuites[].scenarios | length] | add' "${matrix_file}" 2>/dev/null || echo "?")
    echo "  ${total} test scenarios"

    echo ""
    echo -e "${C}Edge Case Categories:${N}"

    jq -r '.edgeCaseCategories | keys[]' "${matrix_file}" 2>/dev/null | while read cat; do
        local count=$(jq -r ".edgeCaseCategories.${cat} | length" "${matrix_file}" 2>/dev/null)
        echo "  ${cat}: ${count} cases"
    done

    echo ""
    echo -e "${W}QUICK COMMANDS${N}"
    divider
    echo "  ./ralph comprehensive 50        # Run all tests"
    echo "  ./ralph comprehensive 30 auth   # Auth tests only"
    echo "  ./ralph comprehensive 30 pay    # Payment tests only"
    echo "  ./ralph e2e critical            # Critical paths only"
    echo ""
}

cmd_mobile_preflight() {
    local platform="${1:-all}"

    banner
    echo -e "${W}MOBILE PRE-FLIGHT CHECK${N}"
    divider
    echo ""

    local errors=0
    local warnings=0

    # React Native checks
    if [[ "${platform}" == "all" ]] || [[ "${platform}" == "react-native" ]]; then
        echo -e "${C}React Native${N}"
        if [[ -f "mobile/package.json" ]] || [[ -f "package.json" ]] && grep -q "react-native" package.json 2>/dev/null; then
            ok "React Native project detected"

            if command -v npx &>/dev/null && npx react-native --version &>/dev/null 2>&1; then
                ok "React Native CLI available"
            else
                warn "React Native CLI not available"
                warnings=$((warnings + 1))
            fi

            if [[ -f "metro.config.js" ]]; then
                ok "Metro bundler config found"
            fi
        else
            info "No React Native project"
        fi
        echo ""
    fi

    # Flutter checks
    if [[ "${platform}" == "all" ]] || [[ "${platform}" == "flutter" ]]; then
        echo -e "${C}Flutter${N}"
        if [[ -f "flutter_app/pubspec.yaml" ]] || [[ -f "pubspec.yaml" ]]; then
            ok "Flutter project detected"

            if command -v flutter &>/dev/null; then
                ok "Flutter CLI installed"
                local flutter_doctor=$(flutter doctor -v 2>/dev/null | grep -E "^\[" | head -5)
                echo -e "${DIM}${flutter_doctor}${N}" | sed 's/^/      /'
            else
                err "Flutter CLI not installed"
                errors=$((errors + 1))
            fi
        else
            info "No Flutter project"
        fi
        echo ""
    fi

    # iOS checks
    if [[ "${platform}" == "all" ]] || [[ "${platform}" == "ios" ]]; then
        echo -e "${C}iOS${N}"
        if [[ -d "ios" ]] || [[ -f "*.xcodeproj" ]] || [[ -f "*.xcworkspace" ]]; then
            ok "iOS project detected"

            if command -v xcodebuild &>/dev/null; then
                ok "Xcode installed"
                local xcode_version=$(xcodebuild -version 2>/dev/null | head -1)
                echo -e "      ${DIM}${xcode_version}${N}"
            else
                err "Xcode not installed"
                errors=$((errors + 1))
            fi

            if command -v pod &>/dev/null; then
                ok "CocoaPods installed"
            else
                warn "CocoaPods not installed"
                warnings=$((warnings + 1))
            fi
        else
            info "No iOS project"
        fi
        echo ""
    fi

    # Android checks
    if [[ "${platform}" == "all" ]] || [[ "${platform}" == "android" ]]; then
        echo -e "${C}Android${N}"
        if [[ -d "android" ]] || [[ -f "build.gradle" ]] || [[ -f "build.gradle.kts" ]]; then
            ok "Android project detected"

            if [[ -n "${ANDROID_HOME:-}" ]] || [[ -d "$HOME/Android/Sdk" ]]; then
                ok "Android SDK found"
            else
                err "ANDROID_HOME not set"
                errors=$((errors + 1))
            fi

            if command -v adb &>/dev/null; then
                ok "ADB available"
            else
                warn "ADB not in PATH"
                warnings=$((warnings + 1))
            fi

            if [[ -f "android/gradlew" ]] || [[ -f "gradlew" ]]; then
                ok "Gradle wrapper found"
            fi
        else
            info "No Android project"
        fi
        echo ""
    fi

    # Summary
    divider
    if [[ ${errors} -gt 0 ]]; then
        echo -e "${R}Pre-flight failed: ${errors} error(s), ${warnings} warning(s)${N}"
        return 1
    elif [[ ${warnings} -gt 0 ]]; then
        echo -e "${Y}Pre-flight passed with ${warnings} warning(s)${N}"
        return 0
    else
        echo -e "${G}All mobile pre-flight checks passed${N}"
        return 0
    fi
}

cmd_test() {
    local zone="${1:-all}"

    banner
    echo -e "${W}RUNNING TESTS${N}"
    divider
    echo ""

    case "${zone}" in
        web|frontend)
            echo -e "${C}Running web tests...${N}"
            npm test 2>&1 || true
            ;;
        e2e|playwright)
            echo -e "${C}Running Playwright E2E tests...${N}"
            npx playwright test 2>&1 || true
            ;;
        mobile|react-native)
            echo -e "${C}Running React Native tests...${N}"
            if [[ -d "mobile" ]]; then
                cd mobile && npm test 2>&1 || true
                cd ..
            else
                npm test 2>&1 || true
            fi
            ;;
        detox)
            echo -e "${C}Running Detox E2E tests...${N}"
            npx detox test -c ios.sim.debug 2>&1 || true
            ;;
        maestro)
            echo -e "${C}Running Maestro tests...${N}"
            maestro test .maestro/ 2>&1 || true
            ;;
        flutter)
            echo -e "${C}Running Flutter tests...${N}"
            if [[ -d "flutter_app" ]]; then
                cd flutter_app && flutter test 2>&1 || true
                cd ..
            else
                flutter test 2>&1 || true
            fi
            ;;
        all|*)
            echo -e "${C}Running all tests...${N}"
            echo ""
            npm test 2>&1 || true
            echo ""
            if [[ -f "playwright.config.ts" ]]; then
                echo -e "${C}Playwright tests...${N}"
                npx playwright test 2>&1 || true
            fi
            ;;
    esac
}

cmd_help() {
    banner

    echo -e "${W}COMMANDS${N}"
    divider
    echo ""
    echo -e "  ${C}Task Creation${N}"
    echo -e "    new              Interactive task wizard (all zones)"
    echo -e "    zone <zone>      Quick zone prompt"
    echo -e "    edit             Edit PROMPT.md"
    echo ""
    echo -e "  ${C}Zones${N}"
    echo -e "    Web:    frontend, backend, database, fullstack"
    echo -e "    Mobile: react-native, flutter, ios, android"
    echo -e "    Test:   tests, e2e"
    echo ""
    echo -e "  ${C}Execution${N}"
    echo -e "    start [N]        Start loop (default: 30 iterations)"
    echo -e "    stop             Stop gracefully"
    echo -e "    preflight        Run pre-flight checks only"
    echo ""
    echo -e "  ${C}Testing${N}"
    echo -e "    e2e [target] [N] Start E2E test loop"
    echo -e "                     Targets: all|web|playwright|mobile|detox|maestro"
    echo -e "    comprehensive [N] [area]  Full testing loop (all paths + edge cases)"
    echo -e "                     Areas: all|auth|pay|onboard|msg"
    echo -e "    test-matrix      View test coverage matrix"
    echo -e "    test [zone]      Run tests for zone"
    echo ""
    echo -e "  ${C}Mobile${N}"
    echo -e "    devices          Show simulators/emulators/devices"
    echo -e "    mobile-check     Mobile environment pre-flight"
    echo ""
    echo -e "  ${C}Monitoring${N}"
    echo -e "    status           State + circuit breaker"
    echo -e "    health           Health check"
    echo -e "    watch            Live activity"
    echo -e "    logs [N]         Log history"
    echo -e "    dashboard        Auto-refresh status"
    echo ""
    echo -e "  ${C}Recovery${N}"
    echo -e "    rollback         Revert to checkpoint"
    echo -e "    reset            Clear all state"
    echo ""
    echo -e "${W}QUICK START${N}"
    divider
    echo ""
    echo "  ./ralph new          # Interactive wizard"
    echo "  ./ralph start 30     # Run loop"
    echo "  ./ralph watch        # Monitor progress"
    echo ""
    echo -e "${W}COMPREHENSIVE TESTING${N}"
    divider
    echo ""
    echo "  ./ralph comprehensive 50        # All tests (auth, pay, onboard, msg...)"
    echo "  ./ralph comprehensive 30 auth   # Authentication only"
    echo "  ./ralph comprehensive 30 pay    # Payments only"
    echo "  ./ralph comprehensive 30 msg    # Messaging only"
    echo "  ./ralph test-matrix             # View test coverage"
    echo ""
    echo -e "${W}E2E TESTING${N}"
    divider
    echo ""
    echo "  ./ralph e2e web      # Web E2E tests (Playwright)"
    echo "  ./ralph e2e mobile   # Mobile E2E (Detox)"
    echo "  ./ralph e2e maestro  # Mobile E2E (Maestro)"
    echo "  ./ralph e2e all      # All E2E tests"
    echo ""
    echo -e "${W}MOBILE DEVELOPMENT${N}"
    divider
    echo ""
    echo "  ./ralph devices      # Check simulators/emulators"
    echo "  ./ralph mobile-check # Mobile pre-flight"
    echo "  ./ralph zone react-native 'Add login screen'"
    echo "  ./ralph zone flutter 'Fix navigation bug'"
    echo ""
    echo -e "${W}SAFETY FEATURES${N}"
    divider
    echo ""
    echo "  • Circuit breaker (stuck detection)"
    echo "  • Git checkpoint (rollback)"
    echo "  • Pre-flight checks"
    echo "  • Cost estimation"
    echo "  • E2E test-fix-retest loop"
    echo ""
}

# ══════════════════════════════════════════════════════════════════════════════
# MAIN
# ══════════════════════════════════════════════════════════════════════════════

case "${1:-help}" in
    # Task Creation
    new)        cmd_new ;;
    zone)       cmd_zone "${2:-fullstack}" "${3:-}" ;;
    edit)       cmd_edit ;;

    # Execution
    start)      cmd_start "${2:-30}" "${3:-}" ;;
    stop)       cmd_stop ;;
    preflight)  cmd_preflight ;;

    # Testing
    e2e)        cmd_e2e "${2:-all}" "${3:-20}" ;;
    comprehensive|full-test) cmd_comprehensive "${2:-50}" "${3:-all}" ;;
    test-matrix|matrix) cmd_test_matrix ;;
    test)       cmd_test "${2:-all}" ;;

    # Mobile
    devices)    cmd_devices ;;
    mobile-check|mobile-preflight) cmd_mobile_preflight "${2:-all}" ;;

    # Monitoring
    status)     cmd_status ;;
    health)     cmd_health ;;
    watch)      cmd_watch ;;
    logs)       cmd_logs "${2:-50}" ;;
    dashboard)  cmd_dashboard ;;

    # Recovery
    rollback)   cmd_rollback ;;
    reset)      cmd_reset ;;

    # Help
    help|-h|--help) cmd_help ;;

    *)
        echo -e "${R}Unknown: $1${N}"
        echo "Run './ralph help'"
        exit 1
        ;;
esac
