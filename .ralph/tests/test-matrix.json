{
  "name": "SAGE MVP Comprehensive Test Matrix",
  "version": "2.0.0",
  "description": "Integrated test coverage for SAGE MVP Platform - aligned with existing test infrastructure",

  "project": {
    "name": "SAGE MVP Platform",
    "description": "Tiered landscape architecture services platform",
    "stack": {
      "frontend": ["React 19", "TypeScript", "React Query", "React Router"],
      "backend": ["Express 5", "Prisma 7", "PostgreSQL", "TypeScript"],
      "testing": ["Jest (backend)", "React Testing Library (frontend)", "Playwright (E2E)"],
      "integrations": ["Stripe", "Notion", "Supabase", "Resend"]
    }
  },

  "commands": {
    "unit": {
      "all": "npm test",
      "backend": "npm run test:backend",
      "frontend": "npm run test:frontend"
    },
    "e2e": {
      "all": "npm run test:e2e",
      "ui": "npm run test:e2e:ui",
      "headed": "npm run test:e2e:headed",
      "report": "npm run test:e2e:report",
      "chromium": "npx playwright test --project=chromium",
      "firefox": "npx playwright test --project=firefox",
      "webkit": "npx playwright test --project=webkit",
      "mobile": "npx playwright test --project='Mobile Chrome' --project='Mobile Safari'"
    },
    "tagged": {
      "critical": "npx playwright test --grep @critical",
      "edge": "npx playwright test --grep @edge",
      "auth": "npx playwright test e2e/auth.spec.ts",
      "checkout": "npx playwright test e2e/checkout.spec.ts",
      "intake": "npx playwright test e2e/intake.spec.ts",
      "landing": "npx playwright test e2e/landing.spec.ts"
    }
  },

  "testSuites": {
    "authentication": {
      "name": "Authentication & Authorization",
      "priority": "critical",
      "existingTests": {
        "e2e": ["e2e/auth.spec.ts"],
        "unit": ["server/src/__tests__/auth.test.ts", "server/src/__tests__/loginProtection.test.ts"]
      },
      "scenarios": [
        {
          "id": "auth-001",
          "name": "User Registration",
          "type": "e2e",
          "steps": ["Navigate to register", "Fill form", "Submit", "Verify email sent", "Confirm account"],
          "edgeCases": ["Duplicate email", "Weak password", "Invalid email format", "Rate limiting"]
        },
        {
          "id": "auth-002",
          "name": "User Login",
          "type": "e2e",
          "steps": ["Navigate to login", "Enter credentials", "Submit", "Verify redirect to portal"],
          "edgeCases": ["Wrong password", "Non-existent user", "Account locked", "Brute force protection"]
        },
        {
          "id": "auth-003",
          "name": "Password Reset",
          "type": "e2e",
          "steps": ["Request reset", "Check email", "Set new password", "Login with new password"],
          "edgeCases": ["Expired token", "Invalid token", "Password requirements"]
        },
        {
          "id": "auth-004",
          "name": "Session Management",
          "type": "unit",
          "tests": ["JWT generation", "Token validation", "Token refresh", "Session expiry"],
          "edgeCases": ["Expired token", "Invalid token", "Concurrent sessions"]
        },
        {
          "id": "auth-005",
          "name": "Role-Based Access",
          "type": "e2e",
          "roles": ["SAGE_ADMIN", "SAGE_CLIENT", "TEAM_MEMBER"],
          "tests": ["Admin dashboard access", "Client portal access", "Team features"],
          "edgeCases": ["Unauthorized access", "Role escalation prevention"]
        }
      ],
      "unitTests": [
        "Password hashing (bcrypt)",
        "JWT token generation/validation",
        "Login protection (brute force)",
        "Rate limiting logic"
      ]
    },

    "intake": {
      "name": "Lead Intake & Tier Recommendation",
      "priority": "critical",
      "existingTests": {
        "e2e": ["e2e/intake.spec.ts"],
        "unit": ["server/src/__tests__/leads.test.ts", "server/src/__tests__/tierFeatures.test.ts"]
      },
      "scenarios": [
        {
          "id": "intake-001",
          "name": "Intake Form Submission",
          "type": "e2e",
          "steps": ["Open intake form", "Fill project details", "Submit", "View tier recommendation"],
          "edgeCases": ["Empty fields", "Invalid data", "Form timeout", "Duplicate submission"]
        },
        {
          "id": "intake-002",
          "name": "Tier Recommendation Engine",
          "type": "unit",
          "tiers": ["Tier 1 - The Concept ($299)", "Tier 2 - The Builder ($1,499)", "Tier 3 - The Concierge ($4,999)", "Tier 4 - White Glove (Custom)"],
          "tests": ["Score calculation", "Tier matching", "Feature comparison"],
          "edgeCases": ["Edge score boundaries", "Multiple qualifying tiers"]
        },
        {
          "id": "intake-003",
          "name": "Lead Management",
          "type": "e2e",
          "steps": ["Lead created", "Admin views lead", "Lead status update", "Lead assignment"],
          "edgeCases": ["Lead duplication", "Status transitions", "Assignment conflicts"]
        }
      ],
      "unitTests": [
        "Tier feature matrix validation",
        "Lead scoring algorithm",
        "Tier recommendation logic",
        "Lead validation"
      ]
    },

    "checkout": {
      "name": "Payment & Checkout",
      "priority": "critical",
      "existingTests": {
        "e2e": ["e2e/checkout.spec.ts"],
        "unit": ["server/src/__tests__/payments.test.ts", "server/src/__tests__/stripeHelpers.test.ts"]
      },
      "scenarios": [
        {
          "id": "checkout-001",
          "name": "Stripe Checkout Session",
          "type": "e2e",
          "steps": ["Select tier", "Click checkout", "Redirect to Stripe", "Complete payment", "Return to success page"],
          "edgeCases": ["Payment declined", "Session timeout", "Duplicate payment prevention"]
        },
        {
          "id": "checkout-002",
          "name": "Stripe Test Cards",
          "type": "e2e",
          "testCards": {
            "success": "4242424242424242",
            "declined": "4000000000000002",
            "expired": "4000000000000069",
            "insufficientFunds": "4000000000009995",
            "requires3DS": "4000002500003155"
          },
          "edgeCases": ["All error card types", "3D Secure flow", "Webhook handling"]
        },
        {
          "id": "checkout-003",
          "name": "Webhook Processing",
          "type": "unit",
          "events": ["checkout.session.completed", "payment_intent.succeeded", "payment_intent.failed"],
          "edgeCases": ["Signature validation", "Duplicate events", "Out-of-order events"]
        },
        {
          "id": "checkout-004",
          "name": "Subscription Management",
          "type": "e2e",
          "actions": ["View subscription", "Upgrade tier", "Cancel subscription", "View billing history"],
          "edgeCases": ["Proration", "Grace period", "Failed renewal"]
        }
      ],
      "unitTests": [
        "Stripe session creation",
        "Webhook signature validation",
        "Payment status transitions",
        "Price calculations"
      ]
    },

    "clientPortal": {
      "name": "Client Portal",
      "priority": "high",
      "existingTests": {
        "integration": ["server/src/__tests__/integration/clientPortalFlow.test.ts"],
        "unit": ["server/src/__tests__/clientService.test.ts", "server/src/__tests__/projects.test.ts", "server/src/__tests__/deliverables.test.ts", "server/src/__tests__/milestoneTemplates.test.ts"]
      },
      "scenarios": [
        {
          "id": "portal-001",
          "name": "Project Dashboard",
          "type": "e2e",
          "steps": ["Login as client", "View projects list", "Select project", "View project details"],
          "edgeCases": ["Empty projects", "Project not found", "Permission denied"]
        },
        {
          "id": "portal-002",
          "name": "Milestone Tracking",
          "type": "e2e",
          "steps": ["View milestones", "Check progress", "View milestone details", "Upload deliverables"],
          "edgeCases": ["Overdue milestones", "Milestone dependencies", "Status transitions"]
        },
        {
          "id": "portal-003",
          "name": "Deliverables Management",
          "type": "e2e",
          "steps": ["View deliverables", "Download file", "Request revision", "Approve deliverable"],
          "edgeCases": ["Large file download", "Invalid file type", "Revision limits"]
        },
        {
          "id": "portal-004",
          "name": "Messaging & Notifications",
          "type": "e2e",
          "steps": ["Send message", "Receive notification", "View message thread", "Mark as read"],
          "edgeCases": ["Offline mode", "Real-time updates", "Notification preferences"]
        }
      ],
      "unitTests": [
        "Client service operations",
        "Project CRUD operations",
        "Deliverable management",
        "Milestone template logic"
      ]
    },

    "adminDashboard": {
      "name": "Admin Dashboard",
      "priority": "high",
      "existingTests": {
        "integration": ["server/src/__tests__/integration/leadToClientFlow.test.ts"],
        "unit": ["server/src/__tests__/leads.test.ts"]
      },
      "scenarios": [
        {
          "id": "admin-001",
          "name": "Lead Queue Management",
          "type": "e2e",
          "steps": ["View leads queue", "Filter leads", "Update lead status", "Convert to client"],
          "edgeCases": ["Empty queue", "Bulk operations", "Concurrent edits"]
        },
        {
          "id": "admin-002",
          "name": "Client Management",
          "type": "e2e",
          "steps": ["View clients list", "Search clients", "View client details", "Manage projects"],
          "edgeCases": ["Large client list", "Search edge cases", "Client archival"]
        },
        {
          "id": "admin-003",
          "name": "Analytics Dashboard",
          "type": "e2e",
          "steps": ["View metrics", "Filter by date range", "Export reports", "View charts"],
          "edgeCases": ["No data period", "Large datasets", "Real-time updates"]
        },
        {
          "id": "admin-004",
          "name": "Team Management",
          "type": "e2e",
          "steps": ["View team members", "Invite member", "Assign roles", "Remove member"],
          "edgeCases": ["Invite expiry", "Role conflicts", "Self-removal prevention"]
        }
      ],
      "unitTests": [
        "Lead to client conversion",
        "Lead status transitions",
        "Analytics aggregation",
        "Team permission logic"
      ]
    },

    "integrations": {
      "name": "Third-Party Integrations",
      "priority": "medium",
      "existingTests": {
        "unit": ["server/src/services/__tests__/webhookService.test.ts", "server/src/services/__tests__/slackService.test.ts"]
      },
      "scenarios": [
        {
          "id": "int-001",
          "name": "Notion Sync",
          "type": "unit",
          "tests": ["Lead sync to Notion", "Deliverable sync", "Status updates"],
          "edgeCases": ["API rate limits", "Connection failures", "Data conflicts"]
        },
        {
          "id": "int-002",
          "name": "Supabase Storage",
          "type": "e2e",
          "tests": ["File upload", "File download", "File deletion"],
          "edgeCases": ["Large files", "Invalid types", "Storage limits", "Presigned URLs"]
        },
        {
          "id": "int-003",
          "name": "Email (Resend)",
          "type": "unit",
          "tests": ["Transactional emails", "Welcome emails", "Notification emails"],
          "edgeCases": ["Delivery failures", "Template errors", "Rate limiting"]
        },
        {
          "id": "int-004",
          "name": "Stripe Webhooks",
          "type": "unit",
          "tests": ["Signature validation", "Event processing", "Idempotency"],
          "edgeCases": ["Replay attacks", "Missing events", "Out-of-order delivery"]
        }
      ],
      "unitTests": [
        "Webhook signature validation",
        "Slack notification formatting",
        "Email template rendering",
        "API retry logic"
      ]
    },

    "messaging": {
      "name": "Real-time Messaging",
      "priority": "high",
      "existingTests": {
        "unit": ["server/src/services/__tests__/messagingService.test.ts", "server/src/services/__tests__/realtimeService.test.ts"]
      },
      "scenarios": [
        {
          "id": "msg-001",
          "name": "Client-Team Communication",
          "type": "e2e",
          "steps": ["Send message", "Receive message", "View history", "Upload attachment"],
          "edgeCases": ["Offline mode", "Reconnection", "Large attachments"]
        },
        {
          "id": "msg-002",
          "name": "Notification System",
          "type": "e2e",
          "channels": ["In-app", "Email"],
          "tests": ["New message notification", "Project update notification", "Mention notification"],
          "edgeCases": ["Notification preferences", "Batching", "Delivery failures"]
        }
      ],
      "unitTests": [
        "Message sanitization",
        "Real-time event broadcasting",
        "Notification priority logic",
        "Message persistence"
      ]
    },

    "services": {
      "name": "Backend Services",
      "priority": "high",
      "existingTests": {
        "unit": [
          "server/src/services/__tests__/cacheService.test.ts",
          "server/src/services/__tests__/emailService.test.ts",
          "server/src/services/__tests__/healthService.test.ts",
          "server/src/services/__tests__/referralService.test.ts",
          "server/src/services/__tests__/calendarService.test.ts"
        ]
      },
      "scenarios": [
        {
          "id": "svc-001",
          "name": "Cache Service (Redis)",
          "type": "unit",
          "tests": ["Cache set/get", "Cache invalidation", "TTL handling"],
          "edgeCases": ["Cache miss", "Connection failure", "Large payloads"]
        },
        {
          "id": "svc-002",
          "name": "Health Service",
          "type": "unit",
          "tests": ["Database health", "Redis health", "External service health"],
          "edgeCases": ["Degraded state", "Complete failure", "Recovery"]
        },
        {
          "id": "svc-003",
          "name": "Referral Service",
          "type": "unit",
          "tests": ["Referral creation", "Referral tracking", "Commission calculation"],
          "edgeCases": ["Expired referrals", "Self-referral prevention"]
        },
        {
          "id": "svc-004",
          "name": "Calendar Service",
          "type": "unit",
          "tests": ["Availability checking", "Booking creation", "Reminder scheduling"],
          "edgeCases": ["Timezone handling", "Conflicting bookings", "Past date prevention"]
        }
      ]
    },

    "infrastructure": {
      "name": "Infrastructure & Configuration",
      "priority": "medium",
      "existingTests": {
        "unit": [
          "server/src/config/__tests__/database.test.ts",
          "server/src/config/__tests__/environment.test.ts",
          "server/src/middleware/__tests__/compression.test.ts",
          "server/src/utils/__tests__/queryOptimization.test.ts"
        ]
      },
      "scenarios": [
        {
          "id": "infra-001",
          "name": "Database Configuration",
          "type": "unit",
          "tests": ["Connection pooling", "Query optimization", "Index usage"],
          "edgeCases": ["Connection timeout", "Pool exhaustion", "Slow queries"]
        },
        {
          "id": "infra-002",
          "name": "Environment Configuration",
          "type": "unit",
          "tests": ["Required vars validation", "Default values", "Type coercion"],
          "edgeCases": ["Missing vars", "Invalid values", "Dev vs prod"]
        },
        {
          "id": "infra-003",
          "name": "Middleware",
          "type": "unit",
          "tests": ["Compression", "CORS", "Rate limiting", "Error handling"],
          "edgeCases": ["Large payloads", "Cross-origin requests", "Burst traffic"]
        }
      ]
    },

    "landing": {
      "name": "Landing & Marketing",
      "priority": "medium",
      "existingTests": {
        "e2e": ["e2e/landing.spec.ts"]
      },
      "scenarios": [
        {
          "id": "land-001",
          "name": "Landing Page",
          "type": "e2e",
          "steps": ["Load page", "View tier comparison", "Navigate to intake", "Check responsive"],
          "edgeCases": ["Slow load", "Mobile viewport", "JavaScript disabled"]
        },
        {
          "id": "land-002",
          "name": "Tier Comparison",
          "type": "e2e",
          "steps": ["View all tiers", "Compare features", "Click CTA", "View pricing"],
          "edgeCases": ["Pricing display", "Feature toggles"]
        }
      ]
    }
  },

  "testingStrategy": {
    "continuous": {
      "description": "Continuous testing loop that runs until all tests pass",
      "phases": [
        {
          "phase": 1,
          "name": "Backend Unit Tests",
          "command": "npm run test:backend",
          "passThreshold": "100%",
          "retries": 3
        },
        {
          "phase": 2,
          "name": "Frontend Unit Tests",
          "command": "npm run test:frontend",
          "passThreshold": "100%",
          "retries": 3
        },
        {
          "phase": 3,
          "name": "E2E Critical Path",
          "command": "npx playwright test --grep @critical",
          "passThreshold": "100%",
          "retries": 3
        },
        {
          "phase": 4,
          "name": "E2E Full Suite (Chromium)",
          "command": "npx playwright test --project=chromium",
          "passThreshold": "100%",
          "retries": 2
        },
        {
          "phase": 5,
          "name": "E2E Cross-Browser",
          "command": "npx playwright test --project=firefox --project=webkit",
          "passThreshold": "95%",
          "retries": 2
        },
        {
          "phase": 6,
          "name": "E2E Mobile",
          "command": "npx playwright test --project='Mobile Chrome' --project='Mobile Safari'",
          "passThreshold": "95%",
          "retries": 2
        },
        {
          "phase": 7,
          "name": "Final Verification",
          "command": "npm test && npm run test:e2e",
          "passThreshold": "100%",
          "consecutiveRuns": 3
        }
      ]
    },
    "parallelization": {
      "workers": "50%",
      "retryFailedTests": true
    },
    "reporting": {
      "formats": ["html", "list"],
      "outputFolder": "playwright-report",
      "screenshots": "only-on-failure",
      "video": "on-first-retry",
      "trace": "on-first-retry"
    }
  },

  "edgeCaseCategories": {
    "input": [
      "Empty input",
      "Maximum length input",
      "Special characters (& < > \" ')",
      "Unicode characters",
      "Script injection attempts",
      "SQL injection attempts",
      "Whitespace only",
      "Negative numbers",
      "Invalid email format",
      "Weak passwords"
    ],
    "state": [
      "First-time user",
      "Returning user",
      "Session timeout",
      "Token expiry",
      "Concurrent sessions",
      "Role transitions",
      "Pending payment",
      "Cancelled subscription"
    ],
    "network": [
      "Slow connection (3G)",
      "Intermittent connection",
      "Request timeout",
      "Server error (500)",
      "Rate limited (429)",
      "Not found (404)",
      "Unauthorized (401)"
    ],
    "payment": [
      "Card declined",
      "Insufficient funds",
      "Expired card",
      "3D Secure required",
      "Duplicate payment",
      "Webhook timeout",
      "Partial refund"
    ],
    "data": [
      "Empty list",
      "Single item",
      "Large dataset (100+ items)",
      "Paginated results",
      "Stale data",
      "Concurrent edits",
      "Deleted references"
    ]
  },

  "existingTestStats": {
    "backend": {
      "total": 262,
      "unit": 190,
      "integration": 36,
      "service": 36
    },
    "frontend": {
      "total": 595,
      "component": 400,
      "api": 195
    },
    "e2e": {
      "files": 4,
      "browsers": ["chromium", "firefox", "webkit", "Mobile Chrome", "Mobile Safari"]
    }
  }
}
