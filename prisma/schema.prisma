// SAGE MVP Platform - Prisma Schema
// This schema defines the Postgres database structure for Supabase

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // Supabase connection string
}

// ============================================
// ENUMS
// ============================================

enum UserType {
  KAA_CLIENT
  SAGE_CLIENT
  TEAM
  ADMIN
}

enum LeadStatus {
  NEW
  QUALIFIED
  NEEDS_REVIEW
  CONVERTED
  CLOSED
}

enum ProjectStatus {
  INTAKE
  ONBOARDING
  IN_PROGRESS
  AWAITING_FEEDBACK
  REVISIONS
  DELIVERED
  CLOSED
}

enum MilestoneStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCEEDED
  FAILED
  REFUNDED
}

enum ClientStatus {
  ONBOARDING
  ACTIVE
  COMPLETED
  CLOSED
}

enum SyncStatus {
  PENDING
  SYNCED
  FAILED
}

// ============================================
// TABLES
// ============================================

model User {
  id           String    @id @default(uuid())
  email        String?   @unique
  name         String?
  address      String? // For KAA clients (address-based auth)
  passwordHash String?   @map("password_hash")
  role         String    @default("CLIENT") // CLIENT, ADMIN, TEAM
  userType     UserType  @default(SAGE_CLIENT) @map("user_type")
  tier         Int? // 1, 2, 3, or 4
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  lastLogin    DateTime? @map("last_login")

  // Relations
  client              Client?
  auditLogs           AuditLog[]
  deliverables        Deliverable[]
  notifications       Notification[]
  messages            Message[]
  revisionRequests    RevisionRequest[] @relation("RevisionRequester")
  revisionsResolved   RevisionRequest[] @relation("RevisionResolver")
  pushSubscriptions   PushSubscription[]

  @@index([email])
  @@index([address])
  @@map("users")
}

model Client {
  id               String       @id @default(uuid())
  userId           String       @unique @map("user_id")
  leadId           String?      @unique @map("lead_id")
  tier             Int // 1, 2, 3, or 4 (required)
  status           ClientStatus @default(ONBOARDING)
  projectAddress   String?      @map("project_address")
  stripeCustomerId String?      @map("stripe_customer_id")
  createdAt        DateTime     @default(now()) @map("created_at")
  updatedAt        DateTime     @updatedAt @map("updated_at")

  // Relations
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  lead     Lead?     @relation("ClientLead", fields: [leadId], references: [id])
  projects Project[]
  leads    Lead[]    @relation("ClientLeads")

  @@index([userId])
  @@index([tier])
  @@index([stripeCustomerId])
  @@map("clients")
}

model Lead {
  id              String      @id @default(uuid())
  email           String
  name            String?
  projectAddress  String      @map("project_address")
  budgetRange     String?     @map("budget_range")
  timeline        String?
  projectType     String?     @map("project_type")
  hasSurvey       Boolean     @default(false) @map("has_survey")
  hasDrawings     Boolean     @default(false) @map("has_drawings")
  recommendedTier Int         @map("recommended_tier") // 1, 2, 3, or 4
  routingReason   String?     @map("routing_reason") // Why this tier was recommended
  tierOverride    Int?        @map("tier_override") // Admin override of recommended tier
  overrideReason  String?     @map("override_reason") // Reason for tier override
  status          LeadStatus  @default(NEW)
  clientId        String?     @map("client_id") // Set when lead converts to client
  notionPageId    String?     @map("notion_page_id") // Link to Notion CRM page
  lastSyncedAt    DateTime?   @map("last_synced_at")
  syncStatus      SyncStatus? @map("sync_status")
  createdAt       DateTime    @default(now()) @map("created_at")
  updatedAt       DateTime    @updatedAt @map("updated_at")

  // Relations
  client        Client?   @relation("ClientLeads", fields: [clientId], references: [id])
  convertedFrom Client?   @relation("ClientLead")
  projects      Project[]

  @@index([email])
  @@index([status])
  @@index([recommendedTier])
  @@map("leads")
}

model Project {
  id             String        @id @default(uuid())
  clientId       String        @map("client_id")
  leadId         String?       @map("lead_id")
  tier           Int // 1, 2, 3, or 4 (required)
  status         ProjectStatus @default(ONBOARDING)
  name           String
  projectAddress String?       @map("project_address")
  notionPageId   String?       @map("notion_page_id") // Link to Notion project page
  paymentStatus  String        @default("pending") @map("payment_status") // 'pending', 'paid', 'refunded'
  lastSyncedAt   DateTime?     @map("last_synced_at")
  syncStatus     SyncStatus?   @map("sync_status")
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  client       Client        @relation(fields: [clientId], references: [id], onDelete: Cascade)
  lead         Lead?         @relation(fields: [leadId], references: [id])
  milestones   Milestone[]
  payments     Payment[]
  deliverables Deliverable[]
  messages     Message[]

  @@index([clientId])
  @@index([tier])
  @@index([status])
  @@map("projects")
}

model Tier {
  id              Int      @id // 1, 2, 3, or 4
  name            String // "The Concept", "The Builder", "The Concierge", "KAA White Glove"
  description     String?
  stripeProductId String?  @map("stripe_product_id")
  stripePriceId   String?  @map("stripe_price_id")
  features        Json? // Array of feature names
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  @@map("tiers")
}

model Milestone {
  id            String          @id @default(uuid())
  projectId     String          @map("project_id")
  tier          Int // Which tier this milestone belongs to
  name          String // "Intake", "Concept", "Draft", "Review", etc.
  order         Int // Display order
  status        MilestoneStatus @default(PENDING)
  dueDate       DateTime?       @map("due_date")
  completedAt   DateTime?       @map("completed_at")
  notionBlockId String?         @map("notion_block_id") // Link to Notion block in project page
  lastSyncedAt  DateTime?       @map("last_synced_at")
  syncStatus    SyncStatus?     @map("sync_status")
  createdAt     DateTime        @default(now()) @map("created_at")

  // Relations
  project          Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  revisionRequests RevisionRequest[]

  @@index([projectId])
  @@index([tier])
  @@map("milestones")
}

model Payment {
  id                      String        @id @default(uuid())
  projectId               String        @map("project_id")
  stripePaymentIntentId   String        @unique @map("stripe_payment_intent_id")
  stripeCheckoutSessionId String?       @map("stripe_checkout_session_id")
  stripeCustomerId        String?       @map("stripe_customer_id")
  amount                  Int // Amount in cents
  currency                String        @default("usd")
  status                  PaymentStatus @default(PENDING)
  tier                    Int? // Which tier was purchased
  paidAt                  DateTime?     @map("paid_at")
  failureReason           String?       @map("failure_reason")
  createdAt               DateTime      @default(now()) @map("created_at")
  updatedAt               DateTime      @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([stripePaymentIntentId])
  @@index([stripeCheckoutSessionId])
  @@index([stripeCustomerId])
  @@map("payments")
}

model Deliverable {
  id           String      @id @default(uuid())
  projectId    String      @map("project_id")
  name         String
  filePath     String      @map("file_path") // Supabase Storage path
  fileUrl      String      @map("file_url") // Public URL
  fileSize     Int         @map("file_size") // Bytes
  fileType     String      @map("file_type") // MIME type
  category     String // "Document", "Photo", "Invoice", etc.
  description  String?
  notionPageId String?     @map("notion_page_id") // Link to Notion showcase page
  lastSyncedAt DateTime?   @map("last_synced_at")
  syncStatus   SyncStatus? @map("sync_status")
  uploadedById String      @map("uploaded_by_id")
  createdAt    DateTime    @default(now()) @map("created_at")

  // Relations
  project    Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy User    @relation(fields: [uploadedById], references: [id])

  @@index([projectId])
  @@index([uploadedById])
  @@map("deliverables")
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String?  @map("user_id")
  action       String // Action enum value (e.g. "LEAD_CREATE", "LOGIN")
  resourceType String?  @map("resource_type") // "USER", "LEAD", "PROJECT", etc.
  resourceId   String?  @map("resource_id") // UUID of the resource
  details      String?  // JSON string with additional context
  ip           String?  // Client IP address
  userAgent    String?  @map("user_agent") // Client user agent
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  user User? @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
  @@map("audit_log")
}

model SyncJob {
  id           String    @id
  entityType   String    @map("entity_type") // PROJECT, MILESTONE, DELIVERABLE, LEAD
  entityId     String    @map("entity_id")
  operation    String // CREATE, UPDATE, DELETE
  status       String // PENDING, PROCESSING, COMPLETED, FAILED, RETRYING
  priority     Int       @default(5)
  retryCount   Int       @default(0) @map("retry_count")
  maxRetries   Int       @default(3) @map("max_retries")
  lastError    String?   @map("last_error")
  notionPageId String?   @map("notion_page_id")
  payload      Json?
  scheduledFor DateTime? @map("scheduled_for")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  @@index([status])
  @@index([entityType, entityId])
  @@index([scheduledFor])
  @@map("sync_jobs")
}

// ============================================
// NOTIFICATIONS & MESSAGING
// ============================================

enum NotificationType {
  PROJECT_UPDATE
  MILESTONE_COMPLETED
  DELIVERABLE_READY
  MESSAGE_RECEIVED
  PAYMENT_RECEIVED
  REVISION_REQUESTED
  SYSTEM
}

model Notification {
  id          String           @id @default(uuid())
  userId      String           @map("user_id")
  type        NotificationType
  title       String
  message     String
  link        String?          // URL to navigate to
  resourceType String?         @map("resource_type") // PROJECT, MILESTONE, DELIVERABLE, etc.
  resourceId  String?          @map("resource_id")
  read        Boolean          @default(false)
  readAt      DateTime?        @map("read_at")
  createdAt   DateTime         @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
  @@index([createdAt])
  @@map("notifications")
}

model Message {
  id          String   @id @default(uuid())
  projectId   String   @map("project_id")
  senderId    String   @map("sender_id")
  content     String
  attachments Json?    // Array of attachment URLs
  isInternal  Boolean  @default(false) @map("is_internal") // Internal team messages
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  sender  User    @relation(fields: [senderId], references: [id])

  @@index([projectId])
  @@index([projectId, createdAt])
  @@index([senderId])
  @@map("messages")
}

model RevisionRequest {
  id          String   @id @default(uuid())
  milestoneId String   @map("milestone_id")
  requesterId String   @map("requester_id")
  description String
  status      String   @default("PENDING") // PENDING, IN_PROGRESS, COMPLETED, DECLINED
  priority    String   @default("NORMAL") // LOW, NORMAL, HIGH
  resolvedAt  DateTime? @map("resolved_at")
  resolvedBy  String?   @map("resolved_by")
  resolution  String?   // Admin notes on resolution
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  milestone Milestone @relation(fields: [milestoneId], references: [id], onDelete: Cascade)
  requester User      @relation("RevisionRequester", fields: [requesterId], references: [id])
  resolver  User?     @relation("RevisionResolver", fields: [resolvedBy], references: [id])

  @@index([milestoneId])
  @@index([requesterId])
  @@index([status])
  @@map("revision_requests")
}

// ============================================
// PUSH NOTIFICATIONS
// ============================================

model PushSubscription {
  id             String    @id @default(uuid())
  userId         String    @map("user_id")
  endpoint       String    @unique
  p256dh         String    // Public key for encryption
  auth           String    // Auth secret
  expirationTime BigInt?   @map("expiration_time")
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@map("push_subscriptions")
}
